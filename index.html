<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marketplace One ‚Äî MEGA All-in-One (Dark Verde) ‚Äî Gbzin</title>
<meta name="description" content="Marketplace + Social + Chat + Admin ‚Äî All-in-One bundle. Frontend (Firebase), server templates (Node.js/Firebase Functions/Stripe), GitHub Actions.">
<style>
  /* ==========================
     THEME DARK VERDE - COMPLEX
     ========================== */
  :root{
    --bg:#051218; --panel:#07161a; --muted:#9fc8b8; --accent:#13c48b; --accent-2:#06b37a; --danger:#ff6b6b;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6fff6;background:linear-gradient(180deg,#041018,#07121a)}
  a{color:inherit}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(2,6,6,.6),rgba(2,6,6,.3));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.02);z-index:50}
  .topbar{max-width:1400px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#032e21}
  .brand h1{margin:0;font-size:18px}
  .searchWrap{flex:1;display:flex;gap:12px;align-items:center}
  .search{display:flex;align-items:center;gap:8px;background:var(--glass);padding:8px;border-radius:999px;width:100%;max-width:760px;border:1px solid rgba(20,120,90,0.06)}
  .search input{flex:1;background:transparent;border:0;padding:8px 10px;color:inherit;outline:0}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#02261a;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.03);color:var(--muted)}
  .container{max-width:1400px;margin:18px auto;padding:0 18px;display:grid;grid-template-columns:280px 1fr 360px;gap:18px}
  .panel{background:linear-gradient(180deg,#061617,#071617);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02)}
  .left{min-height:400px}
  .right{min-height:400px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,#07171a,#061517);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);transition:transform .12s,box-shadow .12s}
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(2,6,12,0.6)}
  .thumb{height:160px;border-radius:8px;overflow:hidden;background:#031213;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;margin-top:8px}
  .desc{color:var(--muted);font-size:13px;height:40px;overflow:hidden}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .price{color:var(--accent);font-weight:900}
  .seller{color:var(--muted);font-size:12px}
  .small{font-size:13px;color:var(--muted)}
  .modal-back{position:fixed;inset:0;background:rgba(1,3,3,.6);display:flex;align-items:center;justify-content:center;z-index:1200}
  .modal{background:linear-gradient(180deg,#071a16,#061614);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:100%;max-width:920px}
  .flex{display:flex;align-items:center;gap:8px}
  .badge{background:rgba(19,196,139,0.08);padding:6px 8px;border-radius:999px;color:var(--accent);font-weight:800}
  footer{max-width:1400px;margin:24px auto;padding:12px 18px;color:var(--muted);font-size:13px}
  pre{background:#02110f;padding:12px;border-radius:8px;overflow:auto;color:#bfffe4}
  @media(max-width:1100px){ .container{grid-template-columns:1fr 360px} .left{display:none} }
  @media(max-width:760px){ .container{grid-template-columns:1fr} .right{display:none} .search{max-width:100%} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">MO</div>
      <div><h1>Marketplace One ‚Äî MEGA</h1><div class="small">Dark ¬∑ Verde ¬∑ All-in-One</div></div>
    </div>

    <div class="searchWrap">
      <div class="search" role="search"><button class="small">üîé</button><input id="q" placeholder="Pesquisar produtos, posts, usu√°rios... (pressione /)" /><select id="sort" style="border:0;background:transparent;color:var(--muted)"><option value="new">Mais recentes</option><option value="price-asc">Menor pre√ßo</option><option value="price-desc">Maior pre√ßo</option><option value="popular">Mais populares</option></select></div>
    </div>

    <div class="actions">
      <button id="btnNewPost" class="btn ghost">+ Post</button>
      <button id="btnAuth" class="btn">Entrar</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- LEFT: perfil / categorias / filtros -->
  <aside class="panel left">
    <div id="userProfile" style="display:flex;gap:12px;align-items:center">
      <div style="width:68px;height:68px;border-radius:12px;background:linear-gradient(90deg,#02382b,#054f3a);display:flex;align-items:center;justify-content:center;font-weight:900">GZ</div>
      <div>
        <div id="profileName" style="font-weight:900">Visitante</div>
        <div id="profileEmail" class="small">N√£o logado</div>
        <div style="margin-top:8px"><button id="btnEditProfile" class="btn ghost">Editar perfil</button></div>
      </div>
    </div>

    <hr style="border:0;height:1px;background:rgba(255,255,255,.02);margin:12px 0"/>

    <div>
      <div class="small" style="font-weight:900;margin-bottom:8px">Categorias</div>
      <div id="categories"></div>
    </div>

    <hr style="border:0;height:1px;background:rgba(255,255,255,.02);margin:12px 0"/>

    <div>
      <div class="small" style="font-weight:900;margin-bottom:8px">Filtros</div>
      <div style="display:flex;gap:8px"><input id="minPrice" placeholder="R$ min"/><input id="maxPrice" placeholder="R$ max"/></div>
      <div style="margin-top:8px"><button id="btnApplyFilters" class="btn">Aplicar</button> <button id="btnClearFilters" class="btn ghost">Limpar</button></div>
    </div>

    <hr style="border:0;height:1px;background:rgba(255,255,255,.02);margin:12px 0"/>

    <div>
      <div class="small" style="font-weight:900;margin-bottom:8px">Atalhos</div>
      <div style="display:flex;flex-direction:column;gap:8px"><button id="btnMyListings" class="btn ghost">Meus an√∫ncios</button><button id="btnMyOrders" class="btn ghost">Pedidos</button><button id="btnAdmin" class="btn ghost">Painel Admin</button></div>
    </div>
  </aside>

  <!-- CENTER: feed / marketplace -->
  <section>
    <div style="display:flex;justify-content:space-between;align-items:end">
      <div>
        <h2>Feed & Marketplace</h2>
        <div class="small" id="resultCount"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="toggleFeedMarket" class="btn ghost">Alternar Feed/Shop</button>
        <button id="btnReload" class="btn">Atualizar</button>
      </div>
    </div>

    <div id="feedArea" style="margin-top:12px">
      <!-- posts & marketplace combined -->
      <div id="feedList" class="grid"></div>
    </div>

    <div id="pagination" style="margin-top:12px"></div>
  </section>

  <!-- RIGHT: cart / chat / notifications -->
  <aside class="panel right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong class="small">Carrinho</strong></div>
      <div><span id="cartCount" class="badge">0</span></div>
    </div>
    <div id="miniCart" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnOpenCart" class="btn">Abrir carrinho</button><button id="btnCheckout" class="btn ghost">Checkout</button></div>

    <hr style="border:0;height:1px;background:rgba(255,255,255,.02);margin:12px 0"/>

    <div><strong class="small">Mensagens</strong><div id="chatPreview" style="margin-top:8px"></div><div style="margin-top:8px"><button id="btnOpenChat" class="btn ghost">Abrir chat</button></div></div>

    <hr style="border:0;height:1px;background:rgba(255,255,255,.02);margin:12px 0"/>

    <div><strong class="small">Notifica√ß√µes</strong><div id="notifications" style="margin-top:8px"></div></div>
  </aside>
</main>

<!-- TEMPLATES / MODALS -->
<template id="tplPostModal">
  <div class="modal-back"><div class="modal">
    <h3>Novo Post / Produto</h3>
    <form id="formPost">
      <input name="title" placeholder="T√≠tulo" required style="width:100%;margin-top:6px"/>
      <textarea name="text" placeholder="Descri√ß√£o / detalhes" style="width:100%;height:100px;margin-top:6px"></textarea>
      <div style="display:flex;gap:8px;margin-top:6px"><input name="price" placeholder="Pre√ßo (opcional)" type="number"/><input name="category" placeholder="Categoria"/></div>
      <div style="margin-top:8px"><input type="file" name="images" multiple /></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px"><button type="button" id="cancelPost" class="btn ghost">Cancelar</button><button type="submit" class="btn">Publicar</button></div>
    </form>
  </div></div>
</template>

<template id="tplChatModal">
  <div class="modal-back"><div class="modal" style="max-width:960px">
    <h3>Chat</h3>
    <div style="display:flex;gap:12px">
      <div style="width:260px">
        <div id="chatUsers" style="max-height:400px;overflow:auto"></div>
      </div>
      <div style="flex:1">
        <div id="chatWindow" style="height:360px;overflow:auto;border-radius:8px;padding:8px;background:#021615"></div>
        <div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" style="flex:1"/><button id="sendChat" class="btn">Enviar</button></div>
      </div>
    </div>
    <div style="text-align:right;margin-top:8px"><button id="closeChat" class="btn ghost">Fechar</button></div>
  </div></div>
</template>

<template id="tplProfileEdit">
  <div class="modal-back"><div class="modal">
    <h3>Editar Perfil</h3>
    <form id="formProfile">
      <input name="displayName" placeholder="Nome" /><input name="bio" placeholder="Bio (curta)" style="margin-top:6px"/><input name="contact" placeholder="Contato (email/wa)"/><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="cancelProfile" class="btn ghost" type="button">Cancelar</button><button type="submit" class="btn">Salvar</button></div>
    </form>
  </div></div>
</template>

<!-- SERVER SCRIPTS (templates EMBEDDED) -->
<section style="max-width:1200px;margin:18px auto;padding:0 18px">
  <h3 style="color:#bfffe4">Blocos Server-side (copie para arquivos separados):</h3>

  <div class="panel">
    <strong>1) Node.js ‚Äî Import Users SCRYPT (import-users-scrypt.js)</strong>
    <pre>
/* import-users-scrypt.js
   Node script to import users hashed with SCRYPT into Firebase Auth (Admin SDK).
   Usage:
     npm i firebase-admin
     node import-users-scrypt.js users.json
*/
const admin = require('firebase-admin');
const fs = require('fs');
const serviceAccount = require('./serviceAccountKey.json');
admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });

const usersFile = process.argv[2];
if(!usersFile){ console.error('usage: node import-users-scrypt.js users.json'); process.exit(1); }

const raw = fs.readFileSync(usersFile, 'utf8');
const users = JSON.parse(raw);

// convert base64 keys from your hash_config
const hash = {
  algorithm: 'SCRYPT',
  signerKey: Buffer.from('n66lOBaDgnBQ9hp2hkH/iCL7R3SKerzVO0wXgFdbGY3u0Fa/GlJ/AaYMBPc/HOFwXGwAM49yiX4sHIN9TR9YIg==','base64'),
  saltSeparator: Buffer.from('Bw==','base64'),
  rounds: 8,
  memoryCost: 1 << 14
};

const firebaseUsers = users.map(u => ({
  uid: u.uid,
  email: u.email,
  displayName: u.displayName,
  passwordHash: Buffer.from(u.hash, 'base64'),
  passwordSalt: Buffer.from(u.salt, 'base64')
}));

admin.auth().importUsers(firebaseUsers, {hash}).then(res => {
  console.log('Import result:', res);
}).catch(err => console.error('Import error', err));
    </pre>
  </div>

  <div class="panel" style="margin-top:12px">
    <strong>2) Firebase Functions ‚Äî Stripe Checkout + Order Webhook (functions/index.js)</strong>
    <pre>
/* functions/index.js
   Example Firebase Function for Stripe Checkout + webhook to mark orders.
   Requires: npm i firebase-admin firebase-functions stripe
*/
const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

exports.createCheckoutSession = functions.https.onCall(async (data, context) => {
  if(!context.auth) throw new functions.https.HttpsError('unauthenticated','Login required');
  const items = data.items; // [{title,unit_amount,quantity}]
  const session = await stripe.checkout.sessions.create({
    payment_method_types:['card'],
    mode:'payment',
    line_items: items.map(i=>({price_data:{currency:'brl',product_data:{name:i.title},unit_amount:Math.round(i.unit_amount*100)},quantity:i.quantity})),
    success_url: data.success_url,
    cancel_url: data.cancel_url,
    metadata:{userId: context.auth.uid}
  });
  // create order placeholder in DB
  const orderRef = admin.database().ref('orders').push();
  await orderRef.set({userId: context.auth.uid, items, status:'pending', sessionId:session.id, createdAt:Date.now()});
  return {url: session.url};
});

// webhook endpoint (use Stripe CLI / set endpoint)
exports.stripeWebhook = functions.https.onRequest(async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;
  try {
    event = stripe.webhooks.constructEvent(req.rawBody, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    console.error('Webhook signature verification failed', err);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }
  if(event.type === 'checkout.session.completed'){
    const session = event.data.object;
    // mark order as paid
    const orders = await admin.database().ref('orders').orderByChild('sessionId').equalTo(session.id).once('value');
    orders.forEach(snap => snap.ref.update({status:'paid', paidAt:Date.now()}));
  }
  res.json({received:true});
});
    </pre>
  </div>

  <div class="panel" style="margin-top:12px">
    <strong>3) GitHub Actions ‚Äî deploy hosting + functions (workflow)</strong>
    <pre>
# .github/workflows/firebase-deploy.yml
name: Deploy Firebase Hosting + Functions
on: push
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: node-version:18
      - run: npm ci
      - name: Decode service account
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: echo "$FIREBASE_SERVICE_ACCOUNT" | base64 --decode > ${{ runner.temp }}/serviceAccountKey.json
      - name: Install firebase tools
        run: npm install -g firebase-tools
      - name: Deploy
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/serviceAccountKey.json
          FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: firebase deploy --project "$FIREBASE_PROJECT" --only hosting,functions
    </pre>
  </div>
</section>

<footer>
  <strong>Instru√ß√µes r√°pidas</strong>
  <ul>
    <li>Front-end usa Firebase Realtime DB + Storage + Auth. Configure regras de seguran√ßa antes de liberar writes p√∫blicos.</li>
    <li>Copie os blocos server-side para arquivos e rode em ambiente seguro (Node.js). Nunca exponha service account no front.</li>
    <li>SCRYPT: converta base64 para Buffer no Node (ex.: Buffer.from('...','base64')).</li>
    <li>Quer que eu gere um ZIP com todos os arquivos prontos (index.html + functions + import script + workflow)? Diga ‚Äúgera zip‚Äù.</li>
  </ul>
</footer>

<!-- Firebase client libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
/*
  Mega frontend JS: marketplace + social + chat + admin (client side)
  Uses:
    - Realtime DB paths:
      /products/{id}
      /posts/{id}
      /users/{uid}
      /chats/{chatId}/messages
      /orders/{id}
      /notifications/{uid}/{nid}
      /reports/{id}
*/
const firebaseConfig = {
  apiKey: "AIzaSyDUextNAsgjKWMBgvZRgpD-ZBMowtyA5g8",
  authDomain: "mercadoone-256a8.firebaseapp.com",
  databaseURL: "https://mercadoone-256a8-default-rtdb.firebaseio.com",
  projectId: "mercadoone-256a8",
  storageBucket: "mercadoone-256a8.firebasestorage.app",
  messagingSenderId: "491377689826",
  appId: "1:491377689826:web:2c5dd9eb5f86b0b424cabb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

const GOOGLE_CLIENT_ID = '491377689826-2cdt9oso75th14msjtlt6veu8k0g1ql6.apps.googleusercontent.com';

// App state
let USER = null;
let PRODUCTS = {};
let POSTS = {};
let CART = JSON.parse(localStorage.getItem('mo_cart')||'[]');
let PAGE = 1;
const PAGE_SIZE = 12;
let MODE = 'feed'; // 'feed' or 'shop'

// Utils
const $ = id => document.getElementById(id);
function el(tag, cls, html){ const d=document.createElement(tag); if(cls) d.className=cls; if(html!==undefined)d.innerHTML=html; return d; }
function toast(msg){ const t = el('div','',''+msg); t.style.background='#062b23'; t.style.color='#bfffe4'; t.style.padding='8px 12px'; t.style.borderRadius='8px'; t.style.marginTop='8px'; t.style.position='fixed'; t.style.left='18px'; t.style.bottom='18px'; t.style.zIndex=2000; document.body.appendChild(t); setTimeout(()=>t.remove(),3500); }
function formatPrice(v){ return 'R$ '+Number(v||0).toFixed(2); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[ch])); }

// Auth UI
$('btnAuth').addEventListener('click', ()=> openAuthModal());
auth.onAuthStateChanged(u=>{
  USER = u;
  if(u){
    $('profileName').textContent = u.displayName || u.email;
    $('profileEmail').textContent = u.email;
    $('btnAuth').textContent = 'Sair';
    loadUserData(u.uid);
  } else {
    $('profileName').textContent = 'Visitante';
    $('profileEmail').textContent = 'N√£o logado';
    $('btnAuth').textContent = 'Entrar';
  }
});

// open auth modal
function openAuthModal(){
  const wrapper = document.createElement('div'); wrapper.className='modal-back'; wrapper.innerHTML = `<div class="modal"><h3>Entrar</h3><div style="display:flex;gap:8px"><button id="gLogin" class="btn ghost">Google</button><button id="eLogin" class="btn">Email</button></div><div style="text-align:right;margin-top:8px"><button id="closeAuth" class="btn ghost">Fechar</button></div></div>`; document.body.appendChild(wrapper);
  wrapper.querySelector('#closeAuth').onclick = ()=>wrapper.remove();
  wrapper.querySelector('#gLogin').onclick = async ()=>{ const provider = new firebase.auth.GoogleAuthProvider(); try{ await auth.signInWithPopup(provider); toast('Logado com Google'); wrapper.remove(); } catch(e){ alert('Erro: '+e.message) } };
  wrapper.querySelector('#eLogin').onclick = ()=>{ wrapper.remove(); openEmailAuthInline(); };
}
function openEmailAuthInline(){
  const wrapper = document.createElement('div'); wrapper.className='modal-back'; wrapper.innerHTML = `<div class="modal"><h3>Email / Senha</h3><input id="aiEmail" placeholder="Email" style="width:100%;margin-top:8px"/><input id="aiPass" type="password" placeholder="Senha" style="width:100%;margin-top:8px"/><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="aCancel" class="btn ghost">Cancelar</button><button id="aLogin" class="btn">Entrar</button><button id="aReg" class="btn ghost">Registrar</button></div></div>`; document.body.appendChild(wrapper);
  wrapper.querySelector('#aCancel').onclick = ()=>wrapper.remove();
  wrapper.querySelector('#aLogin').onclick = async ()=>{ const e = wrapper.querySelector('#aiEmail').value; const p = wrapper.querySelector('#aiPass').value; try{ await auth.signInWithEmailAndPassword(e,p); toast('Logado'); wrapper.remove(); } catch(er){ alert('Erro login: '+er.message) } };
  wrapper.querySelector('#aReg').onclick = async ()=>{ const e = wrapper.querySelector('#aiEmail').value; const p = wrapper.querySelector('#aiPass').value; try{ await auth.createUserWithEmailAndPassword(e,p); await auth.currentUser.sendEmailVerification(); toast('Conta criada. Verifique seu email.'); wrapper.remove(); } catch(er){ alert('Erro registrar: '+er.message) } };
}

// Load user data (profile)
async function loadUserData(uid){
  const snap = await db.ref('users/'+uid).once('value'); const data = snap.val() || {};
  // merge and show
  if(data.displayName) $('profileName').textContent = data.displayName;
  if(data.email) $('profileEmail').textContent = data.email;
}

// Realtime listeners: products, posts, users summary, chats preview
db.ref('products').on('value', snap=>{
  PRODUCTS = snap.val()||{};
  renderFeed();
  renderCategories();
});
db.ref('posts').on('value', snap=>{
  POSTS = snap.val()||{};
  renderFeed();
});

// Render categories
function renderCategories(){
  const container = $('categories'); container.innerHTML = '';
  const cats = new Set();
  Object.values({...PRODUCTS,...POSTS}).forEach(p=>{ if(p && p.category) cats.add(p.category); });
  ['Todas', ...Array.from(cats)].forEach(c=>{
    const elc = el('div','','<div style="display:flex;justify-content:space-between;align-items:center"><div class="small">'+escapeHtml(c)+'</div></div>');
    elc.style.padding='8px'; elc.style.borderRadius='8px'; elc.style.cursor='pointer';
    elc.onclick = ()=>{ if(c==='Todas'){ PAGE=1; renderFeed(); } else { PAGE=1; filterByCategory(c); } };
    container.appendChild(elc);
  });
}

// Filter by category
function filterByCategory(cat){
  // simple filter: set a temporary filtered object for render
  renderFeed({category:cat});
}

// Render feed (posts + product cards)
function renderFeed(opts){
  const feed = $('feedList'); feed.innerHTML = '';
  const q = ($('q').value||'').toLowerCase();
  // combine posts and products into an array with types
  let arr = [];
  Object.entries(POSTS||{}).forEach(([id,p])=>{ arr.push({id,type:'post',...p}); });
  Object.entries(PRODUCTS||{}).forEach(([id,p])=>{ arr.push({id,type:'product',...p}); });
  // apply search
  if(q) arr = arr.filter(x=> (x.title && x.title.toLowerCase().includes(q)) || (x.text && x.text.toLowerCase().includes(q)) || (x.description && x.description.toLowerCase().includes(q)));
  // apply opts category
  if(opts && opts.category) arr = arr.filter(x=> x.category===opts.category);
  // sort
  const s = $('sort').value;
  if(s==='price-asc') arr.sort((a,b)=> (a.price||0)-(b.price||0));
  else if(s==='price-desc') arr.sort((a,b)=> (b.price||0)-(a.price||0));
  else if(s==='popular') arr.sort((a,b)=>(b.likes?Object.keys(b.likes).length:0)-(a.likes?Object.keys(a.likes).length:0));
  else arr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  // pagination
  const total = arr.length; const pages = Math.max(1,Math.ceil(total/PAGE_SIZE));
  if(PAGE>pages) PAGE=pages;
  const start = (PAGE-1)*PAGE_SIZE; arr = arr.slice(start,start+PAGE_SIZE);
  $('resultCount').textContent = `${total} resultados`;
  // render
  arr.forEach(item=>{
    if(item.type==='post'){
      const card = el('div','card');
      const head = el('div','','<div style="display:flex;justify-content:space-between;align-items:center"><strong>'+escapeHtml(item.title||'Post')+'</strong><div class="small">'+(new Date(item.createdAt||0)).toLocaleString()+'</div></div>');
      const txt = el('div','small',escapeHtml(item.text||''));
      const actions = el('div','',`<div style="display:flex;gap:8px;margin-top:8px"><button class="btn ghost">Curtir</button><button class="btn ghost">Comentar</button><button class="btn ghost">Compartilhar</button></div>`);
      card.appendChild(head); card.appendChild(txt); card.appendChild(actions);
      feed.appendChild(card);
    } else {
      // product card with image
      const card = el('div','card');
      const t = el('div','thumb'); if(item.imagePaths && item.imagePaths.length){ const img = document.createElement('img'); img.src = item.imagePaths[0]; img.loading='lazy'; t.appendChild(img); } else t.textContent='Sem imagem';
      card.appendChild(t);
      card.appendChild(el('div','title',escapeHtml(item.title||'Produto')));
      card.appendChild(el('div','desc',escapeHtml(item.description||item.text||'') ));
      const meta = el('div','meta'); meta.innerHTML = `<div><div class="small">${escapeHtml(item.sellerName||'Vendedor')}</div><div style="font-weight:900" class="price">${formatPrice(item.price)}</div></div>`;
      const actions = el('div','','');
      const viewBtn = el('button','btn','Ver'); viewBtn.onclick = ()=> openProductDetail(item.id);
      const addBtn = el('button','btn ghost','+ Carrinho'); addBtn.onclick = ()=> { addToCart(item.id); };
      actions.appendChild(viewBtn); actions.appendChild(addBtn);
      meta.appendChild(actions);
      card.appendChild(meta);
      feed.appendChild(card);
    }
  });
  // pagination render
  const pagWrap = $('pagination'); pagWrap.innerHTML = '';
  for(let i=1;i<=pages;i++){ const b = el('button','btn ghost',i); if(i===PAGE) b.style.opacity=1; b.onclick = ()=>{ PAGE=i; renderFeed(); }; pagWrap.appendChild(b); }
}

// open product detail
function openProductDetail(id){
  const p = PRODUCTS[id];
  if(!p) return alert('Produto n√£o encontrado');
  const modal = document.createElement('div'); modal.className='modal-back';
  const box = document.createElement('div'); box.className='modal';
  box.innerHTML = `<div style="display:flex;gap:12px"><div style="flex:1"><div style="height:360px;border-radius:8px;background:#021615;display:flex;align-items:center;justify-content:center">${p.imagePaths && p.imagePaths[0] ? '<img src="'+p.imagePaths[0]+'" style="width:100%;height:100%;object-fit:cover;border-radius:8px"/>' : 'Sem imagem'}</div></div><div style="flex:1"><h3>${escapeHtml(p.title)}</h3><div class="small">Vendido por: ${escapeHtml(p.sellerName||p.seller)}</div><div style="font-weight:900;color:var(--accent);margin-top:6px">${formatPrice(p.price)}</div><p class="small" style="margin-top:8px">${escapeHtml(p.description)}</p><div style="display:flex;gap:8px;margin-top:12px"><button id="pdAdd" class="btn">Adicionar ao carrinho</button><button id="pdContact" class="btn ghost">Contato</button><button id="pdBuy" class="btn">Comprar agora</button></div></div></div><div style="text-align:right;margin-top:12px"><button id="pdClose" class="btn ghost">Fechar</button></div>`;
  modal.appendChild(box); document.body.appendChild(modal);
  box.querySelector('#pdAdd').onclick = ()=>{ addToCart(id); modal.remove(); };
  box.querySelector('#pdContact').onclick = ()=>{ alert('Contato do vendedor: '+(p.sellerContact||'N√£o informado')); };
  box.querySelector('#pdBuy').onclick = ()=>{ addToCart(id); modal.remove(); toast('Iniciando checkout (simulado). Use Cloud Function para Stripe.'); };
  box.querySelector('#pdClose').onclick = ()=>modal.remove();
}

// CRUD posts & products
$('btnNewPost').onclick = ()=>{ if(!auth.currentUser) return alert('Fa√ßa login'); const tpl = document.getElementById('tplPostModal').content.cloneNode(true); document.body.appendChild(tpl); const back = document.querySelector('.modal-back:last-child'); back.querySelector('#cancelPost').onclick = ()=>back.remove(); back.querySelector('#formPost').onsubmit = async (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); const title = fd.get('title'); const text = fd.get('text'); const price = Number(fd.get('price')||0); const cat = fd.get('category')||'Geral'; const files = ev.target.querySelector('input[type=file]').files; const id = db.ref().child('posts').push().key; const data = { title, text, price, category: cat, createdAt: Date.now(), authorId: auth.currentUser.uid, authorName: auth.currentUser.displayName||auth.currentUser.email }; if(files && files.length){ data.imagePaths=[]; for(let i=0;i<files.length;i++){ const f = files[i]; const path = `posts/${id}/${Date.now()}_${f.name.replace(/\s/g,'_')}`; const ref = storage.ref(path); await ref.put(f); const url = await ref.getDownloadURL(); data.imagePaths.push(url); } } await db.ref('posts/'+id).set(data); toast('Post publicado'); back.remove(); } };

// CART functions
function saveCart(){ localStorage.setItem('mo_cart', JSON.stringify(CART)); renderMiniCart(); }
function addToCart(productId){ const p = PRODUCTS[productId]; if(!p) return toast('Produto indispon√≠vel'); const found = CART.find(x=>x.id===productId); if(found) found.qty++; else CART.push({id:productId,qty:1,title:p.title,price:p.price}); saveCart(); toast('Adicionado ao carrinho'); }
function renderMiniCart(){ const box = $('miniCart'); box.innerHTML=''; let total=0; CART.forEach((it,idx)=>{ const d = el('div','small',`${escapeHtml(it.title)} x${it.qty} ‚Äî ${formatPrice(it.price*it.qty)}`); box.appendChild(d); total += it.qty*it.price; }); $('cartCount').textContent = CART.length; box.appendChild(el('div','small','Total: '+formatPrice(total))); }
$('btnOpenCart').onclick = ()=> openFullCart();
function openFullCart(){ const modal = document.createElement('div'); modal.className='modal-back'; const content = document.createElement('div'); content.className='modal'; content.innerHTML = '<h3>Seu Carrinho</h3><div id="fullCart"></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="closeCart" class="btn ghost">Fechar</button><button id="payCart" class="btn">Pagar</button></div>'; modal.appendChild(content); document.body.appendChild(modal); const list = content.querySelector('#fullCart'); list.innerHTML=''; let total=0; CART.forEach((it,idx)=>{ const r = el('div','','<div style="display:flex;justify-content:space-between"><div>'+escapeHtml(it.title)+' <div class="small">Qtd: '+it.qty+'</div></div><div>'+formatPrice(it.price*it.qty)+'</div></div>'); list.appendChild(r); total += it.qty*it.price; }); list.appendChild(el('div','small','Total: '+formatPrice(total))); content.querySelector('#closeCart').onclick = ()=>modal.remove(); content.querySelector('#payCart').onclick = async ()=>{ if(!auth.currentUser) return alert('Fa√ßa login para pagar'); // example of call to cloud function (client side)
  try{
    // call firebase function createCheckoutSession
    const createCheckout = firebase.functions ? firebase.functions().httpsCallable('createCheckoutSession') : null;
    if(createCheckout){
      const items = CART.map(it=>({title:it.title,unit_amount:it.price,quantity:it.qty}));
      const res = await createCheckout({items, success_url: window.location.href, cancel_url: window.location.href});
      if(res.data && res.data.url) window.location.href = res.data.url;
    } else {
      toast('Checkout simulado ‚Äî configure Cloud Function Stripe.');
    }
  } catch(e){ console.error(e); alert('Erro checkout: '+e.message) }
  modal.remove();
}; }

// Chat (basic via Realtime DB)
$('btnOpenChat').onclick = ()=> openChatModal();
function openChatModal(){
  if(!auth.currentUser) return alert('Fa√ßa login para usar chat');
  const tpl = document.getElementById('tplChatModal').content.cloneNode(true); document.body.appendChild(tpl); const back = document.querySelector('.modal-back:last-child');
  const chatUsers = back.querySelector('#chatUsers'), chatWindow = back.querySelector('#chatWindow'), chatInput = back.querySelector('#chatInput'), sendChat = back.querySelector('#sendChat'), closeChat = back.querySelector('#closeChat');
  // list of chats for this user
  db.ref('chats').orderByChild('members/'+auth.currentUser.uid).equalTo(true).on('value', snap=>{
    const obj = snap.val()||{};
    chatUsers.innerHTML=''; Object.entries(obj).forEach(([chatId, chat])=>{
      const btn = el('div','','<div style="display:flex;justify-content:space-between;align-items:center"><div class="small">'+escapeHtml(chat.title||'Chat')+'</div><div class="small">'+(chat.lastMessageAt?new Date(chat.lastMessageAt).toLocaleString():'')+'</div></div>');
      btn.style.padding='8px'; btn.style.cursor='pointer';
      btn.onclick = ()=> openChatWindow(chatId);
      chatUsers.appendChild(btn);
    });
  });
  function openChatWindow(chatId){
    chatWindow.innerHTML = '';
    const msgRef = db.ref('chats/'+chatId+'/messages');
    msgRef.off();
    msgRef.on('value', snap=>{ const msgs = snap.val()||{}; chatWindow.innerHTML=''; Object.entries(msgs).forEach(([id,m])=>{ const item = el('div','small',`<strong>${escapeHtml(m.senderName||'Anon')}</strong> <div>${escapeHtml(m.text)}</div><div class="small">${new Date(m.createdAt).toLocaleString()}</div>`); item.style.marginBottom='8px'; chatWindow.appendChild(item); }); chatWindow.scrollTop = chatWindow.scrollHeight; });
    sendChat.onclick = async ()=>{ const text = chatInput.value.trim(); if(!text) return; const mid = db.ref().child('chats/'+chatId+'/messages').push().key; const data = { senderId: auth.currentUser.uid, senderName: auth.currentUser.displayName||auth.currentUser.email, text, createdAt: Date.now() }; await db.ref('chats/'+chatId+'/messages/'+mid).set(data); await db.ref('chats/'+chatId).update({ lastMessageAt: Date.now() }); chatInput.value=''; };
  }
  closeChat.onclick = ()=> back.remove();
}

// Admin panel (client-side toggler)
$('btnAdmin').onclick = ()=>{ if(!auth.currentUser) return alert('Fa√ßa login'); // very naive admin guard: check user uid vs list in DB
  db.ref('admin').once('value').then(snap=>{ const admins = snap.val()||[]; if(admins.indexOf(auth.currentUser.uid)===-1) return alert('Sem permiss√£o admin'); openAdminPanel(); });
};
function openAdminPanel(){
  const modal = document.createElement('div'); modal.className='modal-back';
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Painel Admin</h3><div style="display:flex;gap:8px"><button id="btnUsers" class="btn">Usuarios</button><button id="btnReports" class="btn ghost">Reports</button><button id="btnClean" class="btn ghost">Limpar Spams</button></div><div id="adminArea" style="margin-top:12px"></div><div style="text-align:right;margin-top:8px"><button id="closeAdmin" class="btn ghost">Fechar</button></div>`;
  modal.appendChild(box); document.body.appendChild(modal);
  box.querySelector('#closeAdmin').onclick = ()=>modal.remove();
  box.querySelector('#btnUsers').onclick = async ()=>{ const area = box.querySelector('#adminArea'); area.innerHTML = '<div class="small">Carregando usu√°rios...</div>'; const users = await db.ref('users').once('value'); const obj = users.val()||{}; area.innerHTML=''; Object.entries(obj).forEach(([uid,u])=>{ const r = el('div','small',`${escapeHtml(u.displayName||u.email)} ‚Äî ${escapeHtml(u.email||'')} <button class="btn ghost" data-uid="${uid}">Ban</button>`); area.appendChild(r); }); area.querySelectorAll('button[data-uid]').forEach(b=> b.onclick = async ()=>{ const uid = b.getAttribute('data-uid'); if(confirm('Banir usu√°rio?')){ await db.ref('banned/'+uid).set({bannedAt:Date.now()}); toast('Usu√°rio banido (flag)'); } }); };
  box.querySelector('#btnReports').onclick = async ()=>{ const area = box.querySelector('#adminArea'); const rep = await db.ref('reports').once('value'); const obj = rep.val()||{}; area.innerHTML=''; Object.entries(obj).forEach(([id,r])=>{ const it = el('div','small',`[${new Date(r.createdAt).toLocaleString()}] ${escapeHtml(r.desc)} <button class="btn" data-id="${id}">Resolver</button>`); area.appendChild(it); }); area.querySelectorAll('button[data-id]').forEach(b=> b.onclick = async ()=>{ const id = b.getAttribute('data-id'); await db.ref('reports/'+id).remove(); toast('Report removido'); box.querySelector('#btnReports').click(); }); };
}

// Reports (user)
function reportIssue(desc){ const id = db.ref().child('reports').push().key; db.ref('reports/'+id).set({desc,createdAt:Date.now(),user: USER? USER.uid: 'anon'}); toast('Report enviado'); }

// Init small UI events
$('btnApplyFilters').onclick = ()=>{ PAGE=1; renderFeed(); };
$('btnClearFilters').onclick = ()=>{ $('minPrice').value=''; $('maxPrice').value=''; renderFeed(); };
$('btnReload').onclick = ()=>{ renderFeed(); toast('Atualizado'); };
$('toggleFeedMarket').onclick = ()=>{ MODE = MODE==='feed'?'shop':'feed'; toast('Modo: '+MODE); renderFeed(); };

// initial render
renderFeed();
renderMiniCart();

// small helper to seed some demo data (only when empty, for testing)
async function seedDemoData(){
  const prods = await db.ref('products').once('value'); if(prods.exists()) return;
  const p1 = { title:'Fone Gamer', description:'Fone com microfone e RGB', price:129.90, category:'Eletr√¥nicos', sellerId:'sys', sellerName:'Loja Oficial', createdAt:Date.now(), imagePaths:[] };
  const p2 = { title:'Caneca Verde', description:'Caneca t√©rmica 450ml', price:39.9, category:'Casa', sellerId:'sys', sellerName:'Loja Oficial', createdAt:Date.now(), imagePaths:[] };
  await db.ref('products').push(p1); await db.ref('products').push(p2);
  const post = { title:'Bem-vindo ao Marketplace', text:'Teste de feed e marketplace juntos.', createdAt:Date.now(), authorId:'sys', authorName:'Sistema' };
  await db.ref('posts').push(post);
  toast('Dados demo criados');
}
// Uncomment to seed once (only for development)
// seedDemoData();

</script>
</body>
</html>

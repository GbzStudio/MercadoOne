<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marketplace One ‚Äî Dark Premium (Verde)</title>
  <meta name="description" content="Marketplace estilo Mercado Livre / Shopee / Amazon ‚Äî Dark, verde, Firebase Auth, Storage, Realtime DB, carrinho, avalia√ß√µes, painel do vendedor e pop-ups organizados." />
  <style>
    :root{
      --bg:#071018; --panel:#0b1312; --muted:#9fb3aa; --accent:#20c997; --accent-2:#0bd18a; --danger:#ff6b6b; --glass: rgba(255,255,255,0.03);
      --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6f6f1;background:linear-gradient(180deg,#061216 0%,#07121a 100%)}
    a{color:inherit;text-decoration:none}

    /* ===== Header ===== */
    header{position:sticky;top:0;z-index:120;background:linear-gradient(180deg,rgba(2,8,7,0.6),rgba(2,8,7,0.4));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
    .topbar{max-width:1300px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04201a}
    .brand h1{font-size:18px;margin:0}
    .brand small{display:block;color:var(--muted);font-size:12px}

    /* Search */
    .searchWrap{display:flex;flex:1;align-items:center;gap:12px;margin-left:8px}
    .search{display:flex;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;width:100%;max-width:760px;border:1px solid rgba(32,201,151,0.06)}
    .search input{flex:1;background:transparent;border:0;padding:8px 12px;color:inherit;outline:0}
    .suggestions{position:absolute;left:0;right:0;top:54px;background:#071a16;border-radius:8px;padding:8px;border:1px solid rgba(32,201,151,0.06);box-shadow:var(--card-shadow);z-index:140}
    .suggestions div{padding:8px;border-radius:6px;cursor:pointer}
    .suggestions div:hover{background:rgba(255,255,255,0.02)}

    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#012017;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
    .iconBtn{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:6px}

    /* ===== Layout ===== */
    .wrap{max-width:1300px;margin:18px auto;display:grid;grid-template-columns:260px 1fr 360px;gap:20px;padding:0 20px}
    .leftPanel{background:linear-gradient(180deg,#071210,#061411);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .mainPanel{display:flex;flex-direction:column;gap:16px}
    .rightPanel{background:linear-gradient(180deg,#071210,#061114);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}

    /* Categories / filters */
    .sectionTitle{font-weight:800;font-size:13px;margin-bottom:8px;color:var(--muted)}
    .category{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
    .category.active{background:linear-gradient(90deg,rgba(32,201,151,0.06),rgba(11,200,150,0.02));border-color:rgba(32,201,151,0.12)}
    .accordion{margin-bottom:8px}
    .accordion summary{cursor:pointer;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);list-style:none}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,#0b1713,#071217);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);transition:transform .12s ease, box-shadow .12s;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    .card:hover{transform:translateY(-8px);box-shadow:var(--card-shadow)}
    .thumb{height:160px;border-radius:10px;overflow:hidden;background:#051617;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;margin:10px 0 6px}
    .desc{color:var(--muted);font-size:13px;height:44px;overflow:hidden}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .price{color:var(--accent);font-weight:900}
    .seller{color:var(--muted);font-size:12px}
    .badge{background:rgba(32,201,151,0.08);color:var(--accent);padding:4px 8px;border-radius:999px;font-weight:700}

    /* Product quick view popup (modal) */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:160}
    .modal{width:95%;max-width:980px;background:linear-gradient(180deg,#07121a,#041a16);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
    .modal .cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .thumbs-mini{display:flex;gap:8px;margin-top:8px}
    .thumbs-mini img{width:72px;height:72px;object-fit:cover;border-radius:8px;cursor:pointer}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .tab.active{background:rgba(32,201,151,0.06);border-color:rgba(32,201,151,0.12)}

    /* Right column widgets */
    .widget{background:linear-gradient(180deg,#061210,#041212);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px}
    .small{font-size:13px;color:var(--muted)}

    /* Cart drawer improved */
    .cart-drawer{position:fixed;right:20px;top:80px;width:360px;background:#02120f;border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow);z-index:150}
    .cart-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}

    /* Toast notifications */
    .toast-wrap{position:fixed;left:20px;bottom:20px;z-index:200}
    .toast{background:#04281f;color:#d6fff1;padding:10px 14px;border-radius:10px;margin-top:8px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}

    /* Responsive adjustments */
    @media(max-width:1100px){.wrap{grid-template-columns:1fr 360px}.rightPanel{display:none}}
    @media(max-width:720px){.wrap{grid-template-columns:1fr}.search{max-width:100%}.searchWrap{margin-left:0}.brand h1{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">MO</div>
        <div>
          <h1>Marketplace One</h1>
          <small>Dark Premium ‚Äî Verde</small>
        </div>
      </div>

      <div class="searchWrap">
        <div style="position:relative;width:100%">
          <div class="search" role="search">
            <button class="iconBtn" aria-hidden>üîç</button>
            <input id="q" placeholder="Busque produtos, vendedores, categorias..." autocomplete="off" />
            <select id="sort" style="background:transparent;border:0;color:var(--muted);outline:0;margin-left:8px">
              <option value="new">Mais recentes</option>
              <option value="price-asc">Menor pre√ßo</option>
              <option value="price-desc">Maior pre√ßo</option>
              <option value="popular">Mais populares</option>
            </select>
          </div>
          <div id="suggestions" class="suggestions" style="display:none"></div>
        </div>
      </div>

      <div class="actions">
        <button id="btnWishlist" class="iconBtn" title="Favoritos">‚ô°</button>
        <button id="btnSellerDashboard" class="btn ghost">Painel</button>
        <button id="btnAuth" class="btn">Entrar</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <aside class="leftPanel">
      <div>
        <div class="sectionTitle">Navega√ß√£o</div>
        <div class="accordion">
          <details open>
            <summary>Categorias</summary>
            <div id="categories"></div>
          </details>
        </div>

        <div class="sectionTitle">Filtros</div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="minPrice" placeholder="R$ min" type="number" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit" />
          <input id="maxPrice" placeholder="R$ max" type="number" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit" />
        </div>
        <div style="margin-top:10px"><button class="btn" id="btnApplyFilters">Aplicar</button> <button class="btn ghost" id="btnOpenFilters">Abrir filtros</button></div>

        <div style="margin-top:14px">
          <div class="sectionTitle">Conta</div>
          <div id="accountBox" class="small">N√£o logado</div>
          <div style="margin-top:8px;display:flex;gap:6px"><button id="btnGoogle" class="btn ghost">Google</button><button id="btnEmailAuth" class="btn">Email</button></div>
        </div>
      </div>
    </aside>

    <main class="mainPanel">
      <section>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <h2>Produtos</h2>
          <div class="small" id="resultCount"></div>
        </div>

        <div id="products" class="grid"></div>

        <div class="pagination" id="pagination"></div>
      </section>

      <section class="sellerDash" id="sellerSection" style="display:none">
        <h3>Painel do Vendedor</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px"><button id="btnNewProduct" class="btn">+ Novo Produto</button><button id="btnMyProducts" class="btn ghost">Meus Produtos</button></div>
        <div id="sellerContent"></div>
      </section>

      <!-- product detail moved to popup (quick view) -->
    </main>

    <aside class="rightPanel" id="rightPanel">
      <div class="widget">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Bem-vindo</div>
            <div id="rightUser" style="font-weight:800">Visitante</div>
          </div>
          <div class="badge">Vendas</div>
        </div>
      </div>

      <div class="widget">
        <div class="small">Carrinho r√°pido</div>
        <div id="miniCart"></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" id="btnOpenCart">Abrir carrinho</button><button class="btn ghost" id="btnWishlistModal">Favoritos</button></div>
      </div>

      <div class="widget">
        <div class="small">Suporte</div>
        <div style="margin-top:8px"><button class="btn ghost" id="btnContactSupport">Contato</button> <button class="btn" id="btnReportIssue">Reportar</button></div>
      </div>
    </aside>
  </div>

  <!-- CART DRAWER (improved hidden by default) -->
  <div id="cartDrawer" class="cart-drawer" style="display:none"></div>

  <!-- Templates -->
  <template id="tplQuickView">
    <div class="modal-back">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 id="qvTitle">Produto</h3>
          <div>
            <button id="qvClose" class="btn ghost">Fechar</button>
          </div>
        </div>
        <div class="cols" style="margin-top:12px">
          <div>
            <div id="qvImg" style="height:340px;background:#02130f;border-radius:10px;display:flex;align-items:center;justify-content:center">Imagem</div>
            <div class="thumbs-mini" id="qvThumbs"></div>
          </div>
          <div>
            <div id="qvSeller" class="small"></div>
            <div style="margin-top:8px;font-weight:900;color:var(--accent);font-size:20px" id="qvPrice">R$ 0,00</div>
            <div style="margin-top:8px" id="qvDesc"></div>
            <div class="tabs" id="qvTabs">
              <div class="tab active" data-tab="buy">Comprar</div>
              <div class="tab" data-tab="info">Informa√ß√µes</div>
              <div class="tab" data-tab="reviews">Reviews</div>
            </div>
            <div id="qvTabContent" style="margin-top:12px"></div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tplFilters">
    <div class="modal-back">
      <div class="modal" style="max-width:560px">
        <h3>Filtros avan√ßados</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="fMin" placeholder="R$ min" />
          <input id="fMax" placeholder="R$ max" />
        </div>
        <div style="margin-top:8px"><label class="small">Ordenar por</label><select id="fSort"><option value="new">Mais recentes</option><option value="price-asc">Menor pre√ßo</option><option value="price-desc">Maior pre√ßo</option></select></div>
        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button id="closeFilters" class="btn ghost">Cancelar</button><button id="applyFiltersModal" class="btn">Aplicar</button></div>
      </div>
    </div>
  </template>

  <template id="tplWishlist">
    <div class="modal-back">
      <div class="modal" style="max-width:560px">
        <h3>Favoritos</h3>
        <div id="wlList"></div>
        <div style="margin-top:12px;display:flex;justify-content:flex-end"><button class="btn ghost" id="closeWL">Fechar</button></div>
      </div>
    </div>
  </template>

  <template id="tplSupport">
    <div class="modal-back">
      <div class="modal" style="max-width:520px">
        <h3>Contato / Suporte</h3>
        <form id="supportForm">
          <input name="name" placeholder="Seu nome" required style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)" />
          <input name="email" placeholder="Email" required style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)" />
          <textarea name="message" placeholder="Mensagem" required style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)"></textarea>
          <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px"><button type="button" id="closeSupport" class="btn ghost">Cancelar</button><button type="submit" class="btn">Enviar</button></div>
        </form>
      </div>
    </div>
  </template>

  <!-- Firebase compat libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    /***** CONFIGURA√á√ÉO FIREBASE (cole as suas chaves) *****/
    const firebaseConfig = {
      apiKey: "AIzaSyDUextNAsgjKWMBgvZRgpD-ZBMowtyA5g8",
      authDomain: "mercadoone-256a8.firebaseapp.com",
      databaseURL: "https://mercadoone-256a8-default-rtdb.firebaseio.com",
      projectId: "mercadoone-256a8",
      storageBucket: "mercadoone-256a8.firebasestorage.app",
      messagingSenderId: "491377689826",
      appId: "1:491377689826:web:2c5dd9eb5f86b0b424cabb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const GOOGLE_CLIENT_ID = '491377689826-2cdt9oso75th14msjtlt6veu8k0g1ql6.apps.googleusercontent.com';

    // App state
    let PRODUCTS = {};
    let CATEGORIES = new Set();
    let CART = JSON.parse(localStorage.getItem('mo_cart')||'[]');
    let WISHLIST = JSON.parse(localStorage.getItem('mo_wishlist')||'[]');
    const PAGE_SIZE = 12; let currentPage = 1; let currentCategory = null;

    // Utils
    const $ = id=>document.getElementById(id);
    function el(tag, cls, html){const d=document.createElement(tag); if(cls) d.className=cls; if(html!==undefined) d.innerHTML=html; return d}
    function formatPrice(v){return 'R$ '+Number(v).toFixed(2)}
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }
    function toast(msg){ const wrap = document.querySelector('.toast-wrap') || (function(){const w = document.createElement('div'); w.className='toast-wrap'; document.body.appendChild(w); return w})(); const t = document.createElement('div'); t.className='toast'; t.textContent=msg; wrap.appendChild(t); setTimeout(()=>t.remove(),3500); }

    // Auth
    const btnGoogle = $('btnGoogle'); const btnEmailAuth = $('btnEmailAuth'); const btnAuth = $('btnAuth'); const accountBox = $('accountBox'); const rightUser = $('rightUser');
    auth.onAuthStateChanged(user=>{ if(user){ accountBox.textContent = user.displayName || user.email; btnAuth.textContent='Sair'; rightUser.textContent = user.displayName || user.email; } else { accountBox.textContent='N√£o logado'; btnAuth.textContent='Entrar'; rightUser.textContent = 'Visitante'; } });

    btnGoogle.addEventListener('click', async ()=>{ const provider = new firebase.auth.GoogleAuthProvider(); try{ await auth.signInWithPopup(provider); toast('Logado com Google'); }catch(e){alert('Erro Google: '+e.message)} });
    btnEmailAuth.addEventListener('click', ()=>openEmailAuth()); btnAuth.addEventListener('click', ()=>{ if(auth.currentUser) auth.signOut(); else openEmailAuth(); });

    function openEmailAuth(){ const tpl = document.createElement('div'); tpl.innerHTML = `
      <div class="modal-back"><div class="modal" style="max-width:420px"><h3>Entrar / Registrar</h3>
      <input id='authEmail' placeholder='Email' style='width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)' />
      <input id='authPass' placeholder='Senha' type='password' style='width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)' />
      <div style='display:flex;gap:8px;margin-top:10px;justify-content:flex-end'>
        <button id='cancelAuth' class='btn ghost'>Cancelar</button>
        <button id='doLogin' class='btn'>Entrar</button>
        <button id='doRegister' class='btn ghost'>Registrar</button>
      </div></div></div>`; document.body.appendChild(tpl); tpl.querySelector('#cancelAuth').onclick = ()=>tpl.remove(); tpl.querySelector('#doLogin').onclick = async ()=>{ const e=tpl.querySelector('#authEmail').value; const p=tpl.querySelector('#authPass').value; try{ await auth.signInWithEmailAndPassword(e,p); toast('Logado'); tpl.remove(); }catch(er){alert('Erro login: '+er.message)} }; tpl.querySelector('#doRegister').onclick = async ()=>{ const e=tpl.querySelector('#authEmail').value; const p=tpl.querySelector('#authPass').value; try{ await auth.createUserWithEmailAndPassword(e,p); await auth.currentUser.sendEmailVerification(); toast('Conta criada. Verifique seu email.'); tpl.remove(); }catch(er){alert('Erro registrar: '+er.message)} } }

    // Load products
    const productsRef = db.ref('products');
    productsRef.on('value', snap=>{ PRODUCTS = snap.val() || {}; CATEGORIES = new Set(Object.values(PRODUCTS||{}).map(p=>p.category).filter(Boolean)); renderCategories(); renderProducts(); renderMiniCart(); });

    function renderCategories(){ const container = $('categories'); container.innerHTML=''; const all = el('div','category'+(currentCategory? '':' active'),'Todas'); all.onclick=()=>{currentCategory=null;renderProducts()}; container.appendChild(all); Array.from(CATEGORIES).forEach(cat=>{ const c = el('div','category',cat||'Geral'); if(cat===currentCategory) c.classList.add('active'); c.onclick=()=>{ currentCategory=cat; renderProducts(); }; container.appendChild(c); }); }

    // Search suggestions
    const qInput = $('q'); const suggestions = $('suggestions'); qInput.addEventListener('input', ()=>{ const v = qInput.value.trim().toLowerCase(); if(!v){ suggestions.style.display='none'; return; } const entries = Object.values(PRODUCTS||{}).slice(0,40).filter(p=> (p.title && p.title.toLowerCase().includes(v)) || (p.description && p.description.toLowerCase().includes(v)) ).slice(0,6); suggestions.innerHTML = ''; entries.forEach(p=>{ const d = document.createElement('div'); d.textContent = p.title; d.onclick = ()=>{ qInput.value = p.title; suggestions.style.display='none'; renderProducts(); }; suggestions.appendChild(d); }); suggestions.style.display = entries.length? 'block':'none'; });

    // Render products
    function renderProducts(){ const grid = $('products'); grid.innerHTML=''; const q = (qInput.value||'').toLowerCase(); let arr = Object.entries(PRODUCTS).map(([id,p])=>({id,...p})); if(currentCategory) arr = arr.filter(x=>x.category===currentCategory); if(q) arr = arr.filter(x=>[x.title,x.description,x.sellerName,(x.category||'')].some(f=>f && f.toLowerCase().includes(q))); const sort = $('sort').value; if(sort==='price-asc') arr.sort((a,b)=>a.price-b.price); else if(sort==='price-desc') arr.sort((a,b)=>b.price-a.price); else if(sort==='popular') arr.sort((a,b)=>(b.reviews?Object.keys(b.reviews).length:0)-(a.reviews?Object.keys(a.reviews).length:0)); else arr.sort((a,b)=>b.createdAt-a.createdAt);
      const total = arr.length; const pages = Math.max(1,Math.ceil(total/PAGE_SIZE)); if(currentPage>pages) currentPage = pages; const start = (currentPage-1)*PAGE_SIZE; arr = arr.slice(start,start+PAGE_SIZE); $('resultCount').textContent = `${total} resultados`;
      arr.forEach(p=>{ const c = el('div','card'); const t = el('div','thumb'); if(p.imagePaths && p.imagePaths.length){ const img = document.createElement('img'); img.loading='lazy'; img.src = p.imagePaths[0]; t.appendChild(img); } else t.textContent='Sem imagem'; c.appendChild(t); c.appendChild(el('div','title',escapeHtml(p.title))); c.appendChild(el('div','desc',escapeHtml(p.description))); const meta = el('div','meta'); meta.appendChild(el('div','','<div class="price">'+formatPrice(p.price)+'</div><div class="seller">'+escapeHtml(p.sellerName)+'</div>')); const actions = el('div','card-actions'); const btnContact = el('button','btn ghost','Contato'); btnContact.onclick = ()=>openContactSeller(p); const btnView = el('button','btn','Ver'); btnView.onclick = ()=>openQuickView(p.id); const wish = el('button','iconBtn','‚ô°'); wish.onclick = ()=>toggleWishlist(p.id); actions.appendChild(btnContact); actions.appendChild(btnView); actions.appendChild(wish); meta.appendChild(actions); c.appendChild(meta); grid.appendChild(c); });
      // pagination
      const pagWrap = $('pagination'); pagWrap.innerHTML=''; for(let i=1;i<=pages;i++){ const b = el('button','pageBtn',i); if(i===currentPage) b.style.opacity=1; b.onclick = (()=>{ return ()=>{ currentPage = i; window.scrollTo({top:0,behavior:'smooth'}); renderProducts(); } })(); pagWrap.appendChild(b); }
    }

    // Open quick view modal
    function openQuickView(id){ const p = PRODUCTS[id]; if(!p) return toast('Produto n√£o encontrado'); const tpl = document.getElementById('tplQuickView').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); modal.querySelector('#qvTitle').textContent = p.title; modal.querySelector('#qvPrice').textContent = formatPrice(p.price); modal.querySelector('#qvDesc').textContent = p.description; modal.querySelector('#qvSeller').textContent = 'Vendido por: '+(p.sellerName||p.seller);
      const qvImg = modal.querySelector('#qvImg'); qvImg.innerHTML=''; if(p.imagePaths && p.imagePaths.length){ const img = document.createElement('img'); img.src = p.imagePaths[0]; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; qvImg.appendChild(img); }
      const thumbs = modal.querySelector('#qvThumbs'); thumbs.innerHTML=''; if(p.imagePaths) p.imagePaths.forEach(url=>{ const im = document.createElement('img'); im.src = url; im.onclick = ()=>{ qvImg.innerHTML=''; const ii = document.createElement('img'); ii.src = url; ii.style.width='100%'; ii.style.height='100%'; ii.style.objectFit='cover'; qvImg.appendChild(ii); }; thumbs.appendChild(im); });
      // tabs
      const tabs = modal.querySelectorAll('.tab'); const tabContent = modal.querySelector('#qvTabContent'); tabs.forEach(t=> t.onclick = ()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const which = t.dataset.tab; if(which==='buy'){ tabContent.innerHTML = `<div style="display:flex;gap:8px"><button id='qvAddCart' class='btn'>Adicionar ao carrinho</button><button id='qvBuyNow' class='btn ghost'>Comprar agora</button></div>`; modal.querySelector('#qvAddCart').onclick = ()=>{ addToCart(id); toast('Adicionado ao carrinho'); }; modal.querySelector('#qvBuyNow').onclick = ()=>{ addToCart(id); toast('Iniciando checkout... (simulado)'); }; } else if(which==='info'){ tabContent.innerHTML = `<div class='small'>Categoria: ${escapeHtml(p.category||'Geral')}<br>Publicado: ${new Date(p.createdAt).toLocaleString()}</div>`; } else { // reviews
            tabContent.innerHTML = '<div id="qvReviews">'; const reviews = p.reviews || {}; if(Object.keys(reviews).length===0) tabContent.innerHTML = '<div class="small">Sem avalia√ß√µes</div>'; else{ const html = Object.values(reviews).map(r => `<div style="margin-bottom:8px"><strong>${escapeHtml(r.userName||'Anon')}</strong> <span class="small">(${r.rating}/5)</span><div class="small">${escapeHtml(r.text)}</div></div>`).join(''); tabContent.innerHTML = html; }
          } });
      // default tab
      modal.querySelector('.tab[data-tab="buy"]').click();
      modal.querySelector('#qvClose').onclick = ()=>{ document.querySelectorAll('.modal-back:last-child').forEach(x=>x.remove()); };
    }

    // Contact seller popup
    function openContactSeller(p){ const tpl = document.createElement('div'); tpl.innerHTML = `
      <div class="modal-back"><div class="modal" style="max-width:520px"><h3>Contato do vendedor</h3>
        <div class="small" style="margin-top:8px">Vendedor: ${escapeHtml(p.sellerName||p.seller)}</div>
        <div class="small">Contato: ${escapeHtml(p.sellerContact||'N√£o informado')}</div>
        <div style="margin-top:12px"><button id='closeContact' class='btn ghost'>Fechar</button> <button id='copyContact' class='btn'>Copiar</button></div>
      </div></div>`; document.body.appendChild(tpl); tpl.querySelector('#closeContact').onclick = ()=>tpl.remove(); tpl.querySelector('#copyContact').onclick = ()=>{ navigator.clipboard.writeText(p.sellerContact||'').then(()=>toast('Contato copiado')); } }

    /* Reviews modal handled in quick view, also allow write review from product page */
    function openReviewModal(productId){ const tpl = document.getElementById('modalReview').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); modal.querySelector('#btnCloseReview').onclick = ()=>{ document.querySelectorAll('.modal-back:last-child').forEach(x=>x.remove()); };
      modal.querySelector('#formReview').onsubmit = async (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); const rating = Number(fd.get('rating')); const text = fd.get('text'); if(!auth.currentUser) return alert('Fa√ßa login'); const id = db.ref('products/'+productId+'/reviews').push().key; const data = {rating,text,userId:auth.currentUser.uid,userName:auth.currentUser.displayName||auth.currentUser.email,createdAt:Date.now()}; await db.ref('products/'+productId+'/reviews/'+id).set(data); toast('Avalia√ß√£o enviada'); document.querySelectorAll('.modal-back:last-child').forEach(x=>x.remove()); }; }

    // CART
    function saveCart(){ localStorage.setItem('mo_cart',JSON.stringify(CART)); renderMiniCart(); }
    function addToCart(productId){ const p = PRODUCTS[productId]; if(!p) return toast('Produto indispon√≠vel'); const found = CART.find(c=>c.id===productId); if(found) found.qty++; else CART.push({id:productId,qty:1,title:p.title,price:p.price,img:(p.imagePaths&&p.imagePaths[0])||''}); saveCart(); toast('Adicionado ao carrinho'); }
    function renderMiniCart(){ const box = $('miniCart'); box.innerHTML=''; let total=0; CART.forEach(it=>{ const d = el('div','small',`${escapeHtml(it.title)} x${it.qty} ‚Äî ${formatPrice(it.price*it.qty)}`); box.appendChild(d); total += it.price*it.qty; }); const cartDrawer = $('cartDrawer'); cartDrawer.innerHTML = `<div style="font-weight:800">Items: ${CART.length}</div><div class='small'>Total: ${formatPrice(total)}</div><div style='margin-top:8px;display:flex;gap:8px'><button id='openFullCart' class='btn'>Ver carrinho</button> <button id='checkoutQuick' class='btn ghost'>Checkout</button></div>`; const of = document.getElementById('openFullCart'); if(of) of.onclick = ()=>openFullCart(); const chk = document.getElementById('checkoutQuick'); if(chk) chk.onclick = ()=>{ if(!auth.currentUser) return alert('Fa√ßa login'); toast('Checkout simulado'); } }

    function openFullCart(){ // render a full cart modal
      const tpl = document.createElement('div'); tpl.innerHTML = `
        <div class="modal-back"><div class="modal" style="max-width:560px"><h3>Seu Carrinho</h3><div id='fullCart'></div><div style='display:flex;justify-content:flex-end;gap:8px;margin-top:8px'><button id='closeFull' class='btn ghost'>Fechar</button><button id='payFull' class='btn'>Pagar</button></div></div></div>`; document.body.appendChild(tpl);
      const fc = document.getElementById('fullCart'); fc.innerHTML=''; let total=0; CART.forEach((it,idx)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px'; row.innerHTML = `<div style='flex:1'>${escapeHtml(it.title)}<div class='small'>${it.qty} x ${formatPrice(it.price)}</div></div><div style='display:flex;gap:6px'><button class='btn ghost' data-idx='${idx}'>-</button><button class='btn' data-idx='${idx}'>+</button></div>`; fc.appendChild(row); total += it.price*it.qty; }); const footer = document.createElement('div'); footer.style.marginTop='8px'; footer.innerHTML = `<div style='font-weight:800'>Total: ${formatPrice(total)}</div>`; fc.appendChild(footer);
      document.getElementById('closeFull').onclick = ()=>tpl.remove(); document.getElementById('payFull').onclick = ()=>{ if(!auth.currentUser) return alert('Fa√ßa login'); toast('Pagamento simulado ‚Äî integre Stripe/MercadoPago'); };
      tpl.querySelectorAll('.modal-back .btn').forEach(b=>{ b.addEventListener('click', (ev)=>{ const idx = b.getAttribute('data-idx'); if(idx!==null){ const i = Number(idx); if(b.textContent.trim()==='-'){ if(CART[i].qty>1) CART[i].qty--; else CART.splice(i,1); saveCart(); tpl.remove(); openFullCart(); } else { CART[i].qty++; saveCart(); tpl.remove(); openFullCart(); } } }); });
    }

    // Wishlist modal
    function openWishlist(){ const tpl = document.getElementById('tplWishlist').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); const list = modal.querySelector('#wlList'); list.innerHTML=''; WISHLIST.forEach(id=>{ const p = PRODUCTS[id]; if(p) list.appendChild(el('div','small',`${escapeHtml(p.title)} ‚Äî ${formatPrice(p.price)} <button class='btn ghost' data-id='${id}'>Remover</button>`)); }); modal.querySelector('#closeWL').onclick = ()=>modal.remove(); modal.querySelectorAll('button[data-id]').forEach(b=> b.onclick = ()=>{ const id = b.getAttribute('data-id'); const i = WISHLIST.indexOf(id); if(i>=0) WISHLIST.splice(i,1); localStorage.setItem('mo_wishlist',JSON.stringify(WISHLIST)); toast('Removido dos favoritos'); modal.remove(); }); }

    function toggleWishlist(id){ const i = WISHLIST.indexOf(id); if(i>=0){ WISHLIST.splice(i,1); toast('Removido dos favoritos'); } else { WISHLIST.push(id); toast('Adicionado aos favoritos'); } localStorage.setItem('mo_wishlist',JSON.stringify(WISHLIST)); }

    // Seller dashboard and product creation (popups)
    document.getElementById('btnNewProduct').onclick = ()=>openNewProductModal();
    function openNewProductModal(){ const tpl = document.getElementById('modalNewProduct').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); modal.querySelector('#btnCloseNew').onclick = ()=>modal.remove(); modal.querySelector('#formNewProduct').onsubmit = async (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); const title = fd.get('title'); const description = fd.get('description'); const price = Number(fd.get('price')||0); const category = fd.get('category')||'Geral'; const files = ev.target.querySelector('input[type=file]').files; if(!auth.currentUser) return alert('Fa√ßa login'); const id = db.ref().child('products').push().key; const productData = { title, description, price, category, sellerId:auth.currentUser.uid, sellerName:auth.currentUser.displayName||auth.currentUser.email, sellerContact:auth.currentUser.email, isSold:false, createdAt:Date.now() };
        if(files && files.length){ productData.imagePaths = []; for(let i=0;i<files.length;i++){ const f=files[i]; const safe = f.name.replace(/\s/g,'_'); const path = `products/${id}/${Date.now()}_${safe}`; const ref = storage.ref(path); await ref.put(f); const url = await ref.getDownloadURL(); productData.imagePaths.push(url); } }
        await db.ref('products/'+id).set(productData); toast('Produto publicado'); modal.remove(); } }

    // Seller content
    function renderSellerDashboard(){ if(!auth.currentUser) return alert('Fa√ßa login'); const uid = auth.currentUser.uid; const all = Object.entries(PRODUCTS).filter(([id,p])=>p.sellerId===uid); const wrapper = $('sellerContent'); wrapper.innerHTML=''; if(all.length===0) wrapper.textContent = 'Voc√™ ainda n√£o tem produtos.'; else{ const table = el('table','table'); const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>T√≠tulo</th><th>Pre√ßo</th><th>Vendido</th><th>A√ß√µes</th></tr>'; table.appendChild(thead); const tbody = document.createElement('tbody'); all.forEach(([id,p])=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(p.title)}</td><td>${formatPrice(p.price)}</td><td>${p.isSold? 'Sim':'N√£o'}</td><td><button class='btn ghost' data-id='${id}' data-action='edit'>Editar</button> <button class='btn' data-id='${id}' data-action='delete'>Excluir</button></td>`; tbody.appendChild(tr); }); table.appendChild(tbody); wrapper.appendChild(table); wrapper.querySelectorAll('button').forEach(b=>{ b.onclick = async ()=>{ const id = b.getAttribute('data-id'); const action = b.getAttribute('data-action'); if(action==='delete'){ if(confirm('Excluir produto?')){ await db.ref('products/'+id).remove(); toast('Removido'); renderSellerDashboard(); } } else { openEditProductModal(id); } } }); }
    }

    async function openEditProductModal(productId){ const p = PRODUCTS[productId]; if(!p) return toast('Produto n√£o encontrado'); if(!auth.currentUser || auth.currentUser.uid !== p.sellerId) return toast('Sem permiss√£o'); const tpl = document.createElement('div'); tpl.innerHTML = `
      <div class="modal-back"><div class="modal" style="max-width:520px"><h3>Editar produto</h3>
      <input id='editTitle' value='${escapeHtml(p.title)}' style='width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)' />
      <textarea id='editDesc' style='width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)'>${escapeHtml(p.description)}</textarea>
      <input id='editPrice' value='${p.price}' style='width:100%;padding:8px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)' />
      <div style='display:flex;gap:8px;margin-top:10px;justify-content:flex-end'><button id='cancelEdit' class='btn ghost'>Cancelar</button><button id='saveEdit' class='btn'>Salvar</button></div>
      </div></div>`; document.body.appendChild(tpl); tpl.querySelector('#cancelEdit').onclick = ()=>tpl.remove(); tpl.querySelector('#saveEdit').onclick = async ()=>{ const title = tpl.querySelector('#editTitle').value; const desc = tpl.querySelector('#editDesc').value; const price = Number(tpl.querySelector('#editPrice').value||0); if(!title||!desc||price<=0) return alert('Preencha campos v√°lidos'); await db.ref('products/'+productId).update({ title, description:desc, price }); toast('Atualizado'); tpl.remove(); } }

    // Filters modal
    document.getElementById('btnOpenFilters').onclick = ()=>{ const tpl = document.getElementById('tplFilters').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); modal.querySelector('#closeFilters').onclick = ()=>modal.remove(); modal.querySelector('#applyFiltersModal').onclick = ()=>{ const min = Number(modal.querySelector('#fMin').value)||0; const max = Number(modal.querySelector('#fMax').value)||Infinity; currentPage = 1; const prev = PRODUCTS; PRODUCTS = Object.fromEntries(Object.entries(prev).filter(([id,p])=>p.price>=min && p.price<=max)); renderProducts(); PRODUCTS = prev; modal.remove(); }; }

    // Wishlist modal
    document.getElementById('btnWishlist').onclick = ()=>openWishlist(); document.getElementById('btnWishlistModal').onclick = ()=>openWishlist();

    // Support
    document.getElementById('btnContactSupport').onclick = ()=>{ const tpl = document.getElementById('tplSupport').content.cloneNode(true); document.body.appendChild(tpl); const modal = document.querySelector('.modal-back:last-child'); modal.querySelector('#closeSupport').onclick = ()=>modal.remove(); modal.querySelector('#supportForm').onsubmit = async (ev)=>{ ev.preventDefault(); const fd = new FormData(ev.target); // in real app send to support channel
      toast('Mensagem enviada ao suporte (simulado)'); modal.remove(); } }

    // Report issue (quick)
    document.getElementById('btnReportIssue').onclick = async ()=>{ const reason = prompt('Descreva o problema:'); if(reason){ const id = db.ref().child('reports').push().key; awaitSafe(db.ref('reports/'+id).set({reason,createdAt:Date.now(),user: auth.currentUser? auth.currentUser.uid: 'anon'})); toast('Obrigado. Report enviado (simulado)'); } }

    // small helper for awaiting with catch
    async function awaitSafe(p){ try{ await p; }catch(e){ console.error(e); } }

    // Open cart drawer
    document.getElementById('btnOpenCart').onclick = ()=>{ const cd = $('cartDrawer'); cd.style.display = cd.style.display === 'none' ? 'block' : 'none'; renderMiniCart(); }

    // Wishlist persistence
    if(!Array.isArray(WISHLIST)) WISHLIST = [];

    // initial render
    renderProducts(); renderMiniCart();

    // NOTE: hash_config / SCRYPT comment: this is for server-side import only, can't be used client-side.

  </script>
</body>
</html>
